name: Daily Dictionary Update

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

concurrency:
  group: daily-words
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update words.json
        run: |
          python3 << 'EOF'
          import json, datetime

          # last ordbok
          try:
              with open("words.json", "r", encoding="utf-8") as f:
                  words = json.load(f)
          except:
              words = []

          today = datetime.date.today().isoformat()

          # første versjon: legg til 1 nytt ord (enkelt test)
          words.append({
            "no": f"daglig_ord_{today}",
            "lt": "automatiškai",
            "examples": [
              "Dette ordet ble lagt til automatisk.",
              "Systemet fungerer uten manuelt arbeid.",
              "Dette er et eksempel på automatisk oppdatering.",
              "Automatisering sparer tid i hverdagen.",
              "Dette ordet er lagt til av GitHub."
            ]
          })

          with open("words.json", "w", encoding="utf-8") as f:
              json.dump(words, f, ensure_ascii=False, indent=2)
          EOF

      - name: Commit and push (main) with retry
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add words.json
          git commit -m "Automatisk: nytt daglig ord" || echo "No changes to commit"

          # retry 5 ganger hvis GitHub rakk først
          for i in 1 2 3 4 5; do
            git pull --rebase origin main || true
            git push origin HEAD:main && break
            sleep 2
          done
